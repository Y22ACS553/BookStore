@page
@model BookStore.Pages.Books.IndexModel
@{
    ViewData["Title"] = "Book Store";
    var editMode = Model.EditBook != null;
}

<style>
    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .popup-form {
        display: none;
        position: fixed;
        top: 20%;
        left: 50%;
        transform: translate(-50%, -20%);
        padding: 20px;
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        z-index: 1000;
        border-radius: 10px;
    }

    .popup-form input {
        margin-bottom: 10px;
        display: block;
        width: 100%;
    }

    .card-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }

    .book-card {
        border: 1px solid #ccc;
        padding: 15px;
        border-radius: 10px;
        width: 200px;
        background-color: #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .book-card h4 {
        margin: 0;
    }

    .btn-blue {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 6px 10px;
        cursor: pointer;
        margin-top: 5px;
    }

    .btn-red {
        color: red;
        background: none;
        border: none;
        cursor: pointer;
        margin-top: 5px;
    }
</style>

<div class="top-bar">
    <button class="btn-blue" onclick="openAddPopup()">➕ Add Book</button>
    <form method="get">
        <input type="text" name="SearchTerm" placeholder="Search by title..." value="@Model.SearchTerm" />
        <button class="btn-blue" type="submit">🔍 Search</button>
        @if (!string.IsNullOrEmpty(Model.SearchTerm))
        {
            <a asp-page="/Books/Index" class="btn-blue">Show All</a>
        }
    </form>
</div>

@if (!string.IsNullOrEmpty(Model.SearchTerm) && (Model.Books == null || !Model.Books.Any()))
{
    <p><strong>Alaanti Book em ledhu bro.</strong></p>
}

@if (Model.Books != null && Model.Books.Any())
{
    <div class="card-container">
        @foreach (var book in Model.Books)
        {
            <div class="book-card">
                @{
                    string highlightedTitle = string.IsNullOrEmpty(Model.SearchTerm)
                        ? book.Title
                        : book.Title.Replace(Model.SearchTerm, $"<mark>{Model.SearchTerm}</mark>", StringComparison.OrdinalIgnoreCase);
                }
                <h4>@Html.Raw(highlightedTitle)</h4>
                <p><strong>Author:</strong> @book.Author</p>
                <p><strong>Price:</strong> ₹@book.Price</p>
                <form method="post" asp-page-handler="Edit">
                    <input type="hidden" name="Id" value="@book.ID" />
                    <button class="btn-blue" type="submit">Update</button>
                </form>
                <form method="post" asp-page-handler="Delete" onsubmit="return confirm('Are you sure?');">
                    <input type="hidden" name="Id" value="@book.ID" />
                    <button class="btn-red" type="submit">Delete</button>
                </form>
            </div>
        }
    </div>
}

<!-- Add/Edit Popup Form -->
<div id="popupForm" class="popup-form">
    <form method="post" asp-page-handler="Save">
        <input type="hidden" asp-for="Book.ID" />
        <label>Title:</label>
        <input asp-for="Book.Title" />
        <label>Author:</label>
        <input asp-for="Book.Author" />
        <label>Price:</label>
        <input asp-for="Book.Price" type="number" step="0.01" />
        <button class="btn-blue" type="submit">@((editMode) ? "Update" : "Add") Book</button>
        <button class="btn-red" type="button" onclick="closePopup()">Cancel</button>
    </form>
</div>

<script>
    function openAddPopup() {
        document.getElementById('popupForm').style.display = 'block';
    }

    function closePopup() {
        document.getElementById('popupForm').style.display = 'none';
    }

    window.onload = function () {
        var editMode = '@editMode';
        if (editMode === 'True') {
            openAddPopup();
        }
    }
</script>